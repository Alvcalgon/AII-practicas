'''
Created on 5 nov. 2018

@author: Alvaro Calle Glez
'''

import urllib.request

import sqlite3 as dbapi
from bs4 import BeautifulSoup

import tkinter
from tkinter import messagebox

import re


def crear_conexion():
    conn = dbapi.connect('productos.db')
    conn.text_factory = str
    return conn


def cerrar_conexion(conn):
    conn.close()


def cargar():
    conn = crear_conexion()
    
    conn.execute("DROP TABLE IF EXISTS PRODUCTOS")
    conn.execute("""CREATE TABLE PRODUCTOS
        (DENOMINACION TEXT,
         ENLACE TEXT,
         DESCRIPCION TEXT,
         PRECIO REAL,
         OPINIONES INTEGER,
         FORMATO_PACK TEXT);""")
    
    paginas = definir_pagina2()
    
    for pagina in paginas:
        print(pagina)
        documento = procesar_pagina(pagina)
        
        productos = documento.find_all("li", class_ = ["item"])
        
        for producto in productos:
            tag_producto = producto.find("div", class_ = ["product-shop"])
            tag_h2 = tag_producto.find("h2", class_ = ["product-name"])
            tag_box_price = tag_producto.find("div", class_ = ["price-box"])
            
            tag_deno = tag_h2.find("a")
            tag_enlace = producto.find("a")
            tag_precio = tag_box_price.find_all("span", class_ = ["price"])
            
            denominacion = tag_deno.string.strip()
            enlace = tag_enlace['href']
            descripcion = None
            precio = re.compile("^\d+(,\d+)?").search(tag_precio[1].string.strip()).group(0)
            formato = None
            opiniones = None
    
    cerrar_conexion(conn)


def definir_pagina2():
    paginas = []
    
    url_uno = "https://www.origenoliva.com/aceite-de-oliva/mas-vendidos.html"
    url_dos = "https://www.origenoliva.com/aceite-de-oliva/mas-vendidos.html?p=2"
    
    paginas.append(url_uno)
    paginas.append(url_dos)
    
    return paginas


def procesar_pagina(d:str):
    fichero = urllib.request.urlopen(d)
    documento = BeautifulSoup(fichero, 'lxml')
    
    return documento


if __name__ == '__main__':
    pass